generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id                  String                @id @default(uuid())
  wallet              String                @unique
  name                String
  dob                 DateTime
  birthCertificate    String?               // Birth certificate ID/hash
  nationalId          String?               // SSN or national health ID
  emergencyContact    String?
  isMinor             Boolean               @default(false)
  guardianTransferredAt DateTime?           // When control transferred from guardian to patient
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  records             Record[]
  accessRequests      AccessRequest[]
  AccessGrantOffchain AccessGrantOffchain[]
  AuditEvent          AuditEvent[]
  Notification        Notification[]
  guardians           Guardian[]            @relation("PatientGuardians")
  wards               Guardian[]            @relation("GuardianWards")
}

model Record {
  id          String   @id @default(uuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
  recordType  String
  dataHash    String // hash of encrypted blob
  storagePath String? // object store path or CID
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AccessRequest {
  id          String   @id @default(uuid())
  patientId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
  requester   String
  role        String
  reason      String?
  status      String   @default("pending")
  requestedAt DateTime @default(now())
  expiresAt   DateTime
}

model AccessGrantOffchain {
  id           String    @id @default(uuid())
  patientId    String
  patient      Patient   @relation(fields: [patientId], references: [id])
  provider     String
  role         String
  allowedTypes String
  grantedAt    DateTime  @default(now())
  expiresAt    DateTime?
}

model AuditEvent {
  id        String   @id @default(uuid())
  patientId String
  patient   Patient? @relation(fields: [patientId], references: [id])
  recordId  String?
  accessor  String
  action    String
  success   Boolean  @default(true)
  reason    String?
  metadata  Json?
  createdAt DateTime @default(now())
}

model Notification {
  id         String   @id @default(uuid())
  patientId  String
  patient    Patient  @relation(fields: [patientId], references: [id])
  type       String   // access_request, access_granted, access_revoked, record_created, etc.
  title      String
  message    String
  read       Boolean  @default(false)
  priority   String   @default("normal") // low, normal, high, urgent
  metadata   Json?
  createdAt  DateTime @default(now())
  readAt     DateTime?
}

model Guardian {
  id               String   @id @default(uuid())
  patientId        String   // The minor/ward
  patient          Patient  @relation("PatientGuardians", fields: [patientId], references: [id])
  guardianWallet   String   // Guardian's wallet address
  guardianPatientId String? // If guardian is also a patient in system
  guardianPatient  Patient? @relation("GuardianWards", fields: [guardianPatientId], references: [id])
  relationship     String   // "parent", "legal_guardian", "foster_parent"
  canApprove       Boolean  @default(true)
  canView          Boolean  @default(true)
  canCreate        Boolean  @default(true)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  expiresAt        DateTime? // Auto-expires when patient turns 18
  revokedAt        DateTime?

  @@unique([patientId, guardianWallet])
}

model BirthRegistration {
  id                String   @id @default(uuid())
  patientId         String   @unique
  birthCertificateId String  @unique
  birthDate         DateTime
  birthPlace        String   // Hospital/city
  birthWeight       Float?   // in grams
  birthLength       Float?   // in cm
  motherName        String?
  fatherName        String?
  attendingPhysician String?
  registeredBy      String   // Hospital/clinic wallet
  registeredAt      DateTime @default(now())
  metadata          Json?    // Additional birth details
}
